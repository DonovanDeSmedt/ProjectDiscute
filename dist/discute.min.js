/*! discute 10-12-2016 */
"use strict";var requires=["ui.router","ngResource","ngTouch","ngFileUpload","ngCookies","ngImgCrop","discuteApp.home","discuteApp.profile","discuteApp.create","discuteApp.service","discuteApp.global","discuteApp.auth","discuteApp.directive"];angular.module("discuteApp",requires),angular.module("discuteApp").config(function($stateProvider,$httpProvider,$urlRouterProvider){$httpProvider.interceptors.push("authInterceptor"),$httpProvider.defaults.withCredentials=!0,$httpProvider.defaults.xsrfCookieName="csrftoken",$httpProvider.defaults.xsrfHeaderName="X-CSRFToken",$httpProvider.interceptors.push("myCSRF"),$urlRouterProvider.otherwise("/home"),$stateProvider.state("home",{cache:!1,url:"/home",templateUrl:"js/home/home.html",controller:"HomeController",controllerAs:"homeCtrl",resolve:{logincheck:checkLoggedIn,background:function($rootScope){$rootScope.currentTag=null},data:function(DModule){return DModule.getDiscutes().then(function(discutes){return discutes})}}}).state("world",{cache:!1,url:"/world",templateUrl:"js/home/world.html",controller:"HomeController",controllerAs:"homeCtrl",resolve:{logincheck:checkLoggedIn,background:function($rootScope){$rootScope.currentTag=null},data:function(DModule){return DModule.getGeneralDiscutes().then(function(discutes){return splitArray(discutes)})}}}).state("search",{cache:!1,url:"/search/:name",templateUrl:"js/home/search.html",controller:"HomeController",controllerAs:"homeCtrl",resolve:{logincheck:checkLoggedIn,data:function(DModule,$stateParams){return DModule.searchTag($stateParams.name,null).then(function(discutes){return splitArray(discutes)})}}}).state("profile",{cache:!1,url:"/profile",templateUrl:"js/profile/profile.html",controller:"ProfileController",controllerAs:"profileCtrl",resolve:{logincheck:checkLoggedIn}}).state("add-discute",{cache:!1,url:"/add-discute",templateUrl:"js/create/create.html",controller:"CreateController",controllerAs:"createCtrl",resolve:{logincheck:checkLoggedIn}}).state("mobile-discute-view",{cache:!1,url:"/discute/:id",templateUrl:"js/partials/discute_modal_mobile.html",controller:"HomeController",controllerAs:"homeCtrl",resolve:{logincheck:checkLoggedIn,data:function(DModule,$stateParams,$state){return DModule.getDiscuteById($stateParams.id).then(function(discute){return discute}).catch(function(err){console.log(err),$state.go("404")})}}}).state("user",{cache:!1,url:"/profile/:username",templateUrl:"js/profile/profile.html",controller:"ProfileController",controllerAs:"profileCtrl",resolve:{logincheck:checkLoggedIn}}).state("edit",{cache:!1,url:"/account/:username",templateUrl:"js/profile/edit_profile.html",controller:"ProfileController",controllerAs:"profileCtrl",resolve:{logincheck:checkLoggedIn,usercheck:checkUser}}).state("login",{cache:!1,url:"/login",templateUrl:"js/auth/login.html",controller:"LoginController"}).state("register",{cache:!1,url:"/register",templateUrl:"js/auth/register.html",controller:"RegisterController"}).state("api",{cache:!1,url:"/api",resolve:{api:function(){window.location.href="apidoc/index.html"}},templateUrl:"apidoc/index.html"}).state("404",{cache:!1,url:"/404",templateUrl:"js/404/404.html",controller:"GlobalController"})}).constant("_",window._).run(function($state,$http,$cookies){$state.go("home")}).provider("myCSRF",[function(){var headerName="X-CSRFToken",cookieName="csrftoken",allowedMethods=["GET"];this.setHeaderName=function(n){headerName=n},this.setCookieName=function(n){cookieName=n},this.setAllowedMethods=function(n){allowedMethods=n},this.$get=["$cookies",function($cookies){return{request:function(config){return allowedMethods.indexOf(config.method)===-1&&(config.headers[headerName]=$cookies.get(cookieName)),config}}}]}]);var checkLoggedIn=function($q,$timeout,$cookies,$http,$location,$rootScope,$state,AuthenticationService){var deferred=$q.defer();return $rootScope.prevURL=$location.path(),null==$cookies.getObject("currentUser")?(AuthenticationService.Logout(),deferred.reject(),$state.go("login"),window.location.href="/#/login",!1):(deferred.resolve(),deferred.promise)},checkUser=function($q,$stateParams,$rootScope){var deferred=$q.defer();return console.log($stateParams.username),angular.isUndefined($rootScope.currentUser)||$stateParams.username===$rootScope.currentUser.username?deferred.resolve():(deferred.reject(),$state.go("profile")),deferred.promise},splitArray=function(discutes){for(var prevIndex=0,nextIndex=3,newArray=[],i=0;i<discutes.length/3;i++)newArray.push(discutes.slice(prevIndex,nextIndex)),prevIndex=nextIndex,nextIndex+=3;var rest=discutes%3;return rest&&newArray.push(discutes.slice(discutes.length-rest,discutes.length-1)),newArray};!function(){function loginCtrl($scope,$rootScope,$state,$http,AuthenticationService){$http.get("/login").then(function(data){}).catch(function(err){console.log(err)}),$(".login-background").show(),$scope.submitLoginForm=function(user){return angular.isUndefined(user)||null===user?($scope.errorMessage="Email or password incorrect",!1):void AuthenticationService.Login(user.email,user.password,function(result){result===!0?$state.go("home"):$scope.errorMessage="Email or password incorrect"})}}angular.module("discuteApp.auth",[]).controller("LoginController",["$scope","$rootScope","$state","$http","AuthenticationService",loginCtrl])}(),function(){function registerCtrl($scope,$state,$http,AuthenticationService){$scope.submitForm=function(form,user){return!!form.$valid&&(user.username=removeWhiteSpace(user.username),void AuthenticationService.Register(user,function(result,data){result?AuthenticationService.Login(user.email,user.password,function(loginResult){loginResult&&$state.go("home")}):("email"===data&&($scope.emailError=!0,$scope.usernameError=!1,$("#email").addClass("invalid"),$("#username").removeClass("invalid")),"username"===data&&($scope.usernameError=!0,$scope.emailError=!1,$("#email").removeClass("invalid"),$("#username").addClass("invalid")))}))};var removeWhiteSpace=function(word){word.trim();var index=word.indexOf(" ");return index>=0&&(word=word.replace(/ /g,"")),word}}angular.module("discuteApp.auth").controller("RegisterController",["$scope","$state","$http","AuthenticationService",registerCtrl])}(),function(){function createCtrl($scope,$rootScope,$cookies,$state,AuthenticationService,Upload,DModule,$timeout,DiscuteService){function triggerUpload(side){"left"===side?$timeout(function(){$("#upload-image-left").click()}):"right"===side&&$timeout(function(){$("#upload-image-right").click()})}function customSearch(name,side){DiscuteService.customSearch(name).then(function(img){switch(angular.isUndefined(self.discute.picture)&&(self.discute.picture={}),side){case"left":self.discute.picture.left="uploads/"+img.data;break;case"right":self.discute.picture.right="uploads/"+img.data}}).catch(function(err){console.log(err)})}function upload(leftPicture,rightPicture){if(null===leftPicture?$("#discute-side-left").addClass("upload-invalid"):$("#discute-side-left").removeClass("upload-invalid"),null===rightPicture?$("#discute-side-right").addClass("upload-invalid"):$("#discute-side-right").removeClass("upload-invalid"),null!==rightPicture&&null!==leftPicture){var discute=self.discute,fd=new FormData;discute.tags=$.map(discute.tags,function(value,index){return"#"!=value[0]&&(value="#"+removeWhiteSpace(value)),value});for(var key in discute)fd.append(key,discute[key]);fd.append("author",$rootScope.currentUser.username),fd.append("leftPicture",Upload.dataUrltoBlob(leftPicture,"blobleft")),fd.append("rightPicture",Upload.dataUrltoBlob(rightPicture,"blobright")),DiscuteService.uploadDiscute(fd).then(function(response){$rootScope.initScrollPos(),$state.go("home")})}}function removeWhiteSpace(word){word.trim();var index=word.indexOf(" ");return index>=0&&(word=word.replace(/ /g,"")),word}var self=this;self.app="iDiscute",self.discute={},self.discute.tags=[],self.triggerUpload=triggerUpload,self.customSearch=customSearch,self.upload=upload,self.removeWhiteSpace=removeWhiteSpace,$rootScope.updateCurrentUser(),autosize($("textarea")),$scope.$watch("discute.description",function(newValue,oldValue){newValue&&newValue.length>150&&($scope.discute.description=oldValue)}),$("#delete-right").click(function(){self.discute.picture.right=""}),$("#delete-left").click(function(){self.discute.picture.left=""})}angular.module("discuteApp.create",[]).controller("CreateController",["$scope","$rootScope","$cookies","$state","AuthenticationService","Upload","DModule","$timeout","DiscuteService",createCtrl])}(),angular.module("discuteApp.directive",[]).directive("passwordValidator",function(){return{require:"ngModel",link:function(scope,elm,attrs,ctl){scope.$watch(attrs.passwordValidator,function(errorMsg){elm[0].setCustomValidity(errorMsg),ctl.$setValidity("passwordValidator",!!errorMsg)})}}}).directive("discuteHeader",function(){return{restrict:"AE",replace:!0,templateUrl:"js/directives/header.html"}}).directive("loginBackground",function(){return{restrict:"AE",replace:!0,templateUrl:"js/directives/loginBackground.html",controller:"GlobalController"}}).directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter,{event:event})}),event.preventDefault())})}}).directive("iosDblclick",function(){var firstClickTime,DblClickInterval=300,waitingSecondClick=!1;return{restrict:"A",link:function(scope,element,attrs){element.bind("click",function(e){if(waitingSecondClick){waitingSecondClick=!1;var time=(new Date).getTime();time-firstClickTime<DblClickInterval&&scope.$apply(attrs.iosDblclick)}else firstClickTime=(new Date).getTime(),waitingSecondClick=!0,setTimeout(function(){waitingSecondClick=!1},DblClickInterval)})}}}),function(){function globalCtrl($scope,$rootScope,$cookies,$http,$state,$location,$timeout,AuthenticationService){$rootScope.rootImgUrl="http://res.cloudinary.com/dvf32xjxh/image/upload/v1480612233/",$scope.logout=function(){AuthenticationService.Logout(),$state.go("login")},$rootScope.setCurrentTag=function(tag){$rootScope.currentTag=$rootScope.searchItem=tag},$rootScope.splitArray=function(discutes){for(var prevIndex=0,nextIndex=3,newArray=[],i=0;i<discutes.length/3;i++)newArray.push(discutes.slice(prevIndex,nextIndex)),prevIndex=nextIndex,nextIndex+=3;var rest=discutes%3;return rest&&newArray.push(discutes.slice(discutes.length-rest,discutes.length-1)),newArray},$rootScope.goLeft=function(){$rootScope.index>0?$rootScope.index--:$rootScope.parentIndex>0&&($rootScope.parentIndex--,$rootScope.index=$rootScope.currentDiscuteArray[$rootScope.parentIndex].length-1),$rootScope.currentDiscute=$rootScope.currentDiscuteArray[$rootScope.parentIndex][$rootScope.index]},$rootScope.goRight=function(){$rootScope.index<$rootScope.currentDiscuteArray[$rootScope.parentIndex].length-1?$rootScope.index++:$rootScope.parentIndex<$rootScope.currentDiscuteArray.length-1&&($rootScope.parentIndex++,$rootScope.index=0),$rootScope.currentDiscute=$rootScope.currentDiscuteArray[$rootScope.parentIndex][$rootScope.index]},$rootScope.setCurrentDiscute=function(index,parentIndex,array){$rootScope.currentDiscuteArray=array,$rootScope.parentIndex=parentIndex,$rootScope.index=index,$rootScope.currentDiscute=array[parentIndex][index]},$rootScope.updateCurrentUser=function(){if(!$cookies.getObject("currentUser")||!$cookies.getObject("currentUser").username)return AuthenticationService.Logout(),$state.go("login"),!1;var username=$cookies.getObject("currentUser").username;return new Promise(function(resolve,reject){$http.get("/user/"+username).then(function(user){$rootScope.currentUser=user.data,resolve()}).catch(function(err){err&&(console.log(err),(err.data="Unauthorized")&&$state.go("login"))})})},$rootScope.prevPage=function(){$location.path($rootScope.prevURL)},$scope.scrollPos={},$(window).on("scroll",function(){$scope.okSaveScroll&&($scope.scrollPos[$location.path()]=$(window).scrollTop())}),$rootScope.initScrollPos=function(){$scope.scrollPos={}},$scope.scrollClear=function(path){$scope.scrollPos[path]=0},$scope.$on("$stateChangeStart",function(){$scope.okSaveScroll=!1}),$scope.$on("$stateChangeSuccess",function(){$timeout(function(){$(window).scrollTop($scope.scrollPos[$location.path()]?$scope.scrollPos[$location.path()]:0),$scope.okSaveScroll=!0},0)})}angular.module("discuteApp.global",[]).controller("GlobalController",["$scope","$rootScope","$cookies","$http","$state","$location","$timeout","AuthenticationService",globalCtrl])}(),function(){function homeController($scope,$rootScope,$cookies,$state,$location,AuthenticationService,DModule,data){function logout(){AuthenticationService.Logout(),$state.go("login")}function comment(comment,side,discute){checkAvailability();var index=self.discutes.indexOf(discute);DModule.addComment(comment,side,discute,$rootScope.currentUser.username),index===-1?("right"===side&&($rootScope.currentDiscute.right.comment=""),"left"===side&&($rootScope.currentDiscute.left.comment="")):("right"===side&&(self.discutes[index].right.comment="",self.visible_right=!0),"left"===side&&(self.discutes[index].left.comment="",self.visible_left=!0))}function vote(side,discute){checkAvailability(),DModule.vote(side,discute,$rootScope.currentUser.username)}function deleteComment(side,comment,indexComment,discute){checkAvailability(),DModule.deleteComment(side,comment,indexComment,discute,$rootScope.currentUser.username)}function order(sort){self.isOrderedList=!0,self.orderType=sort,angular.isUndefined($rootScope.currentTag)||null===$rootScope.currentTag?angular.isUndefined(self.searchDiscutes)||null===self.searchDiscutes?DModule.orderBy(sort,self.discutes).then(function(discutes){self.discutes=$rootScope.splitArray(discutes),$scope.$apply()}):DModule.searchAndOrder(self.searchTerm,sort,self.searchDiscutes).then(function(discutes){self.searchDiscutes=$rootScope.splitArray(discutes),$scope.$apply()}):DModule.tagAndOrder($rootScope.currentTag,sort,self.discutes).then(function(discutes){self.discutes=$rootScope.splitArray(discutes),$scope.$apply()})}function search(){$rootScope.prevURL=$location.path(),DModule.search(self.searchTerm,null).then(function(discutes){initDropDown(),self.searchDiscutes=$rootScope.splitArray(discutes),$rootScope.searchItem=self.searchTerm,$scope.$apply()})}function closeSearch(){angular.isUndefined($rootScope.currentTag)||null===$rootScope.currentTag||($rootScope.currentTag=null,$location.path($rootScope.prevURL)),self.searchDiscutes=$rootScope.searchItem=self.searchTerm=null,initDropDown()}function loadMore(sort,array){DModule.loadMore(sort,array,self.isOrderedList,self.orderType,$rootScope.searchItem).then(function(discutes){switch(sort){case"home":discutes.forEach(function(discute,index){self.discutes.push(discute)});break;case"tag":case"world":complementDiscutes(self.discutes,discutes);break;case"search":complementDiscutes(self.searchDiscutes,discutes)}$scope.$apply()})}function complementDiscutes(dest,array){for(;dest[dest.length-1].length<3&&array.length>0;)dest[dest.length-1].push(array.splice(0,1)[0]);array.length>0&&splitArray(array).forEach(function(arr,index){dest[dest.length+index]=arr})}function initDropDown(){$(".dropdown-toggle").text("Best Rated"),$(".dropdown-toggle").append($("<span>").addClass("caret"))}function checkAvailability(){$cookies.getObject("currentUser")&&$cookies.getObject("currentUser").username&&$rootScope.currentUser&&$rootScope.currentUser.username||(console.log("HomeController"),AuthenticationService.Logout(),$state.go("login"))}var self=this;self.logout=logout,self.comment=comment,self.vote=vote,self.deleteComment=deleteComment,self.order=order,self.closeSearch=closeSearch,self.loadMore=loadMore,self.initDropDown=initDropDown,self.complementDiscutes=complementDiscutes,self.checkAvailability=checkAvailability,self.search=search,autosize($("textarea")),self.discutes=data,$(".dropdown-menu li a").click(function(){$(".dropdown-toggle").text($(this).text()),$(".dropdown-toggle").append($("<span>").addClass("caret"))}),$location.path().indexOf("search")<0&&null!==$rootScope.searchItem&&($rootScope.searchItem=null)}angular.module("discuteApp.home",[]).controller("HomeController",["$scope","$rootScope","$cookies","$state","$location","AuthenticationService","DModule","data",homeController])}(),function(){function profileCtrl($scope,$rootScope,$state,$stateParams,$cookies,$window,AuthenticationService,DModule,Upload,ProfileService){function getUser(){ProfileService.getUser($stateParams.username).then(function(user){self.user={},self.user.username=user.data.username,self.user.email=user.data.email,self.user.discutes=user.data.discutes,self.user.followers=user.data.followers,self.user.discuteArray=$rootScope.splitArray(user.data.discutes)}).catch(function(err){401===err.status&&(console.log("ProfileController"),AuthenticationService.Logout(),$state.go("login")),console.log("Error while fetching user"),$rootScope.errorMessage="User not found",$state.go("404")})}function editProfileForm(user){update_account($rootScope.currentUser.email.toLowerCase(),user.email.toLowerCase())}function changePasswordForm(user){update_password(user)}function triggerUpload(){$("#upload-profile-picture").click()}function upload_picture(){update_profile_picture(self.newProfilePicture),console.log("Succes"),$("#profilePictureModal").modal("hide")}function follow(user){if(user!=$rootScope.currentUser.username){var indexToFollow=$rootScope.currentUser.following.indexOf(user),indexFollower=self.user.followers.indexOf($rootScope.currentUser.username);indexToFollow>=0?($rootScope.currentUser.following.splice(indexToFollow,1),self.user.followers.splice(indexFollower,1)):($rootScope.currentUser.following.push(user),self.user.followers.push($rootScope.currentUser.username)),ProfileService.follow($rootScope.currentUser.username,$rootScope.currentUser.following,user).then(function(data){console.log("Following user:"+user)}).catch(function(err){console.log(err)})}}function comment(comment,side,discute){checkAvailability(),DModule.addComment(comment,side,discute,$rootScope.currentUser.username),"right"===side&&angular.isDefined($rootScope.currentDiscute)&&($rootScope.currentDiscute.right.comment=""),"left"===side&&angular.isDefined($rootScope.currentDiscute)&&($rootScope.currentDiscute.left.comment="")}function vote(side,discute){checkAvailability(),DModule.vote(side,discute,$rootScope.currentUser.username)}function deleteComment(side,comment,indexComment,discute){checkAvailability(),DModule.deleteComment(side,comment,indexComment,discute,$rootScope.currentUser.username)}function deleteDiscute(){bootbox.confirm("Are you sure?",function(result){result&&($rootScope.currentDiscuteArray[$rootScope.parentIndex][$rootScope.index]=null,DModule.deleteDiscute($rootScope.currentDiscute),$("#discuteModal").modal("hide"),$scope.$apply(),$window.location.reload())})}function logout(){AuthenticationService.Logout(),$state.go("login")}function closeModal(tag){$("#discuteModal").modal("hide"),$("#profilePictureModal").modal("hide")}function checkAvailability(){$rootScope.currentUser&&$rootScope.currentUser.username||(console.log("HomeController"),AuthenticationService.Logout(),$state.go("login"))}function update_profile_picture(picture){var fd=new FormData;null!=picture&&(fd.append("picture",Upload.dataUrltoBlob(picture,"profilePicture")),ProfileService.updateProfilePicture($rootScope.currentUser.username,fd).then(function(data){console.log("Successfuly updated profile picture")}))}function update_account(oldEmail,newEmail){ProfileService.updateAccount(oldEmail,newEmail).then(function(data){bootbox.alert("Successfuly updated email",function(result){$rootScope.currentUser.email=newEmail;var currentUser=$cookies.getObject("currentUser");currentUser.email=newEmail,$cookies.putObject("currentUser",currentUser)})}).catch(function(err){"email"===err.data&&(self.emailError=!0,self.usernameError=!1,$("#email").addClass("invalid"),$("#username").removeClass("invalid")),"username"===err.data&&(self.usernameError=!0,self.emailError=!1,$("#email").removeClass("invalid"),$("#username").addClass("invalid"))})}function update_password(user){ProfileService.updatePassword(user.currentPassword,user.newPassword,$rootScope.currentUser.email).then(function(data){data.data.success?(console.log("Successfuly updated password"),self.currentPasswordError=!1,$("#current-password").removeClass("invalid")):(self.currentPasswordError=!0,$("#current-password").addClass("invalid"),console.log(data.data.message))}).catch(function(err){console.log(err)})}var self=this;self.getUser=getUser,self.editProfileForm=editProfileForm,self.changePasswordForm=changePasswordForm,self.triggerUpload=triggerUpload,self.comment=comment,self.vote=vote,self.follow=follow,self.deleteComment=deleteComment,self.deleteDiscute=deleteDiscute,self.logout=logout,self.closeModal=closeModal,self.checkAvailability=checkAvailability,self.update_profile_picture=update_profile_picture,self.update_password=update_password,self.update_account=update_account,self.upload_picture=upload_picture,$(document.body).click(function(){$("#discuteModal").modal("hide")}),$(".modal-dialog").click(function(event){event.stopPropagation()}),$rootScope.updateCurrentUser()}angular.module("discuteApp.profile",[]).controller("ProfileController",["$scope","$rootScope","$state","$stateParams","$cookies","$window","AuthenticationService","DModule","Upload","ProfileService",profileCtrl])}(),function(){function AuthenticationFactory($http,$cookies,$rootScope){function login(email,password,callback){$http.post("/login",{username:email,password:password}).then(function(response){response.data.token?($rootScope.currentUser={email:email,token:response.data.token,username:response.data.username,following:response.data.following},$cookies.putObject("currentUser",{email:email,token:response.data.token,username:response.data.username,test:"Zever"}),callback(!0)):callback(!1)}).catch(function(err){callback(!1)})}function register(user,callback){$http.post("/register",user).then(function(){callback(!0)}).catch(function(data,status,headers,config){console.log("Fail"),callback(!1,data.data)})}function logout(){$cookies.remove("currentUser"),$rootScope.currentUser=null,$http.defaults.headers.common.Authorization=""}var service={};return service.Login=login,service.Logout=logout,service.Register=register,service}angular.module("discuteApp.service",["ngCookies"]).factory("AuthenticationService",["$http","$cookies","$rootScope",AuthenticationFactory])}(),function(){function authInterceptor($cookies){return{request:function(config){return $cookies.getObject("currentUser")&&(config.headers.Authorization=$cookies.getObject("currentUser").token),config}}}angular.module("discuteApp.service").factory("authInterceptor",["$cookies",authInterceptor])}(),function(){function discuteService($http){function uploadDiscute(fd){return $http.post("/discute/new",fd,{transformRequest:angular.indentity,headers:{"Content-Type":void 0}})}function customSearch(name){return $http.get("pictures/search/custom/"+name)}var service={};return service.uploadDiscute=uploadDiscute,service.customSearch=customSearch,service}angular.module("discuteApp.service").factory("DiscuteService",["$http",discuteService])}(),angular.module("discuteApp.service").factory("_",function($window){return!$window._,$window._}),function(){function dModule($state,$http,$rootScope,AuthenticationService,$cookies){return function(){var discutes=void 0,_homeData=function(index){return $rootScope.updateCurrentUser().then(function(){return $http.get("/discute/"+$rootScope.currentUser.username+"/"+index).then(function(data){return data.data.discutes}).catch(function(err){console.log(err)})}).catch(function(err){console.log(err)})},_worldData=function(index){return $rootScope.updateCurrentUser().then(function(){return $http.get("/discute/"+index).then(function(data){return data.data.discutes})}).catch(function(err){console.log(err)})},getDiscutes=function(){return _homeData(0)},getGeneralDiscutes=function(){return _worldData(0)},getDiscuteById=function(id){return $rootScope.updateCurrentUser().then(function(){return $http.get("/discute/findBy/id/"+id).then(function(data){return data.data.discute[0]})})},deleteDiscute=function(discute){discute.author===$rootScope.currentUser.username&&$http.delete("/discute/"+discute._id).then(function(data){}).catch(function(err){console.log(err)})},addComment=function(comment,side,discute,username){return $http.put("/discute/comment/"+discute._id,{user:username,comment:comment,side:side}).then(function(data){return _updateDiscute(discute,data.data.left,data.data.right),discute}).catch(function(err){console.log(err),AuthenticationService.Logout(),$state.go("login")})},vote=function(side,discute,username){$http.put("/discute/vote/"+discute._id,{user:username,side:side}).then(function(data){_updateDiscute(discute,data.data.left,data.data.right)}).catch(function(err){console.log(err),AuthenticationService.Logout(),$state.go("login")})},deleteComment=function(side,comment,indexComment,discute,username){if(comment.name===username){var id=void 0;return"left"===side&&(id=discute.left.comments[indexComment]._id),"right"===side&&(id=discute.right.comments[indexComment]._id),$http.put("/discute/uncomment/"+discute._id,{side:side,id:id}).then(function(data){return _updateDiscute(discute,data.data.left,data.data.right),discute}).catch(function(err){console.log(err),AuthenticationService.Logout(),$state.go("login")})}},_updateDiscute=function(discute,left,right){discute.right.votes=right.votes,discute.right.comments=right.comments,discute.left.votes=left.votes,discute.left.comments=left.comments},search=function(name,array){var index=null===array?0:Math.floor(_calculateLenghtDiscutes(array)/21);return"#"===name[0]?searchTag(name.slice(1),null):new Promise(function(resolve,reject){$http.get("/search/"+name.trim()+"/"+index).then(function(data){discutes=data.data.discutes,resolve(discutes)})})},searchTag=function(name,array){var index=null===array?0:Math.floor(_calculateLenghtDiscutes(array)/21);return new Promise(function(resolve,reject){$http.get("/search/tag/"+name+"/"+index).then(function(data){discutes=data.data.discutes,resolve(discutes)})})},tagAndOrder=function(name,sort,array){var index=Math.floor(_calculateLenghtDiscutes(array)/21);return new Promise(function(resolve,reject){$http.get("/search/tagAndOrder/"+name.slice(1)+"/"+sort+"/"+index).then(function(data){discutes=data.data.discutes,resolve(discutes)})})},orderBy=function(sort,array){var index=Math.floor(_calculateLenghtDiscutes(array)/21);return new Promise(function(resolve,reject){$http.get("/search/orderby/"+sort+"/"+index).then(function(data){discutes=data.data.discutes,resolve(discutes)}).catch(function(err){console.log(err)})})},searchAndOrder=function(search,sort,array){var index=Math.floor(_calculateLenghtDiscutes(array)/21);return"#"===search[0]?tagAndOrder(search,sort,array):new Promise(function(resolve,reject){$http.get("/search/searchAndOrder/"+search+"/"+sort+"/"+index).then(function(data){discutes=data.data.discutes,resolve(discutes)}).catch(function(err){console.log(err)})})},loadMore=function(sort,array,isOrdered,order,searchTerm){var index=void 0;switch(sort.toLowerCase()){case"home":return index=Math.floor(array.length/12),_homeData(index);case"world":return index=Math.floor(_calculateLenghtDiscutes(array)/21),angular.isUndefined(isOrdered)||!isOrdered?_worldData(index):orderby(order,array);case"search":return angular.isUndefined(isOrdered)||!isOrdered?search(searchTerm,array):searchAndOrder(searchTerm,order,array);case"tag":return index=Math.floor(_calculateLenghtDiscutes(array)/21),angular.isUndefined(isOrdered)||!isOrdered?searchTag(searchTerm.slice(1),array):tagAndOrder(searchTerm,order,array)}},_calculateLenghtDiscutes=function(discutes){var length=0;return discutes.forEach(function(array,index){length+=array.length}),length};return{getDiscutes:getDiscutes,getGeneralDiscutes:getGeneralDiscutes,getDiscuteById:getDiscuteById,deleteDiscute:deleteDiscute,addComment:addComment,vote:vote,deleteComment:deleteComment,orderBy:orderBy,search:search,searchTag:searchTag,searchAndOrder:searchAndOrder,tagAndOrder:tagAndOrder,loadMore:loadMore}}()}angular.module("discuteApp.service").factory("DModule",["$state","$http","$rootScope","AuthenticationService","$cookies",dModule])}(),function(){function profileService($http,$cookies,$rootScope){function getUser(username){return $http.get("/user/"+username)}function updateAccount(oldEmail,newEmail){return $http.put("/user/account/"+oldEmail,{new:newEmail})}function updatePassword(currentPassword,newPassword,email){return $http.put("/user/changePassword/",{currentPassword:currentPassword,password:newPassword,email:email})}function updateProfilePicture(username,fd){return $http.put("/user/profile_picture/"+username,fd,{transformRequest:angular.indentity,headers:{"Content-Type":void 0}})}function follow(username,following,user){return $http.put("/user/follow/"+username,{following:following,userToFollow:user,follower:username})}var service={};return service.getUser=getUser,service.updateAccount=updateAccount,service.updatePassword=updatePassword,service.updateProfilePicture=updateProfilePicture,service.follow=follow,service}angular.module("discuteApp.service").factory("ProfileService",["$http","$cookies","$rootScope",profileService])}();